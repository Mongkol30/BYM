<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${appName}">BeeryYummyMap</title>

    <!-- Leaflet CSS -->
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
            integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
            crossorigin=""
    />

    <style>
        body {
            margin: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #fef9ff;
        }

        header {
            padding: 12px 20px;
            background: linear-gradient(90deg, #ffb6c9, #ffe29f);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .logo {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .logo span {
            font-size: 1.5rem;
        }

        .tagline {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        #map {
            height: calc(100vh - 60px); /* ‡πÄ‡∏ï‡πá‡∏°‡∏à‡∏≠ ‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á header */
            width: 100vw;
        }

        .leaflet-container {
            background: #fdf5ff;
        }

        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 32px;
            color: white;
            background: #ff6fa8;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 9999;
        }

        .floating-btn:hover {
            transform: scale(1.08);
            background: #ff85bc;
        }

        .beer-pin {
            font-size: 28px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <span>üç∫</span> <span th:text="${appName}"></span>
    </div>
    <div class="tagline">
        ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏ß‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏£‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏µ‡∏¢‡∏£‡πå
    </div>
</header>

<div id="map"></div>
<button id="addBtn" class="floating-btn">+</button>

<script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="">
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        const fallbackLat = 13.7563;
        const fallbackLng = 100.5018;
        const fallbackZoom = 12;

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        const map = L.map('map').setView([fallbackLat, fallbackLng], fallbackZoom);

        // tile layer
        L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}.png', {
            maxZoom: 20,
            attribution: '&copy; Stadia Maps'
        }).addTo(map);

        // icon üç∫ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô
        const beerIcon = L.divIcon({
            html: '<div class="beer-pin">üç∫</div>',
            className: '',
            iconSize: [60, 60],
            iconAnchor: [16, 32]
        });

        // ‡∏ñ‡πâ‡∏≤ browser ‡πÉ‡∏´‡πâ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ä‡πâ location ‚Üí zoom ‡πÑ‡∏õ‡πÉ‡∏Å‡∏•‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    const userLat = pos.coords.latitude;
                    const userLng = pos.coords.longitude;
                    map.setView([userLat, userLng], 14);
                },
                function (err) {
                    console.warn("geo error:", err);
                }
            );
        }

        // üëâ ‡∏î‡∏∂‡∏á pin ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å backend
        fetch('/api/homepin/pins')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(pins => {
                if (!Array.isArray(pins)) {
                    console.warn("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å /api/homepin/pins ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà array", pins);
                    return;
                }

                const bounds = [];

                pins.forEach(pin => {
                    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏Å‡∏´‡∏•‡πà‡∏ô
                    if (!pin.latitude || !pin.longitude) {
                        return;
                    }

                    const lat = Number(pin.latitude);
                    const lng = Number(pin.longitude);

                    const marker = L.marker([lat, lng], { icon: beerIcon }).addTo(map);

                    // popup ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô + ‡πÄ‡∏≠‡∏≤ restaurantId ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏î‡πâ
                    const popupHtml =
                        `<strong>${pin.restaurantName ?? '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô'}</strong><br/>` +
                        (pin.address ? `${pin.address}<br/>` : '') +
                        (pin.restaurantId ? `<a href="/restaurants/${pin.restaurantId}">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏£‡πâ‡∏≤‡∏ô</a>` : '');

                    marker.bindPopup(popupHtml);

                    bounds.push([lat, lng]);
                });

                // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 pin ‚Üí zoom ‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [40, 40] });
                }
            })
            .catch(err => {
                console.error("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• /api/homepin/pins ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err);
            });

        // ‡∏õ‡∏∏‡πà‡∏° + ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô
        const addBtn = document.getElementById("addBtn");
        if (addBtn) {
            addBtn.addEventListener("click", () => {
                window.location.href = "/add";
            });
        }
    });
</script>

</body>
</html>
